<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EELib WASM Test</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 2rem; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        #log { background: #f0f0f0; padding: 1rem; border-radius: 4px; font-family: monospace; white-space: pre-wrap;}
    </style>
</head>
<body>
    <h1>EELib WASM Loader</h1>
    <p>Status: <span id="status">Loading...</span></p>
    
    <h3>Console Output:</h3>
    <div id="log"></div>

    <script src="eelib.js"></script>
    <script>
        const logDiv = document.getElementById('log');
        const statusSpan = document.getElementById('status');
        
        function log(msg) {
            logDiv.textContent += msg + '\n';
            console.log(msg);
        }

        createEelib().then(Module => {
            statusSpan.textContent = 'Module Loaded!';
            statusSpan.className = 'success';
            
            log("WASModule initialized.");

            try {
                log("Running ABM Simulation...");

                // Initialize ABM
                const abm = new Module.ABM();
                log("ABM initialized");

                // Create Single Producer
                const producer = new Module.Producer(1, "FOOD", 100);
                abm.addAgent(producer);

                // Create Consumers
                const appetite = new Module.tick(5);
                const numConsumers = 10;
                for(let traderId = 10; traderId <(numConsumers + 10); traderId++){
                    const consumer = new Module.Consumer(traderId, "FOOD", 500, appetite);
                    abm.addAgent(consumer);
                }
                log(`Agents added. Total agents: ${abm.getNumAgents()}`);

                // Run Simulation Steps
                log("Starting simulation loop...");
                let step = 0;
                const maxSteps = 200;

                const runStep = () => {
                    if (step >= maxSteps) {
                        log("Simulation complete.");
                        return;
                    }

                    abm.simStep();
                    step++;
                    
                    const obs = abm.getLatestObservation();
                    // obs.time is a tick object
                    const time = obs.time.raw();

                    // Check spreads for FOOD
                    // observation.assetSpreads is a MapStringSpread
                    let spreadInfo = "No Spread";
                    const spread = obs.assetSpreads.get("FOOD");
                    if (spread) {
                        spreadInfo = `Bid:${spread.highestBid} Ask:${spread.lowestAsk}`;
                    }
                    
                    // Optionally check depth
                    let depthInfo = "";
                    const depth = obs.assetOrderDepths.get("FOOD");
                    if (depth) {
                         // Just presence check
                    }

                    log(`Step ${step} | Time: ${time} | FOOD: ${spreadInfo}`);
                    
                    setTimeout(runStep, 0);
                };

                runStep();

            } catch (e) {
                log("Error: " + e.message);
                statusSpan.textContent = 'Error during test';
                statusSpan.className = 'error';
                console.error(e);
            }
        }).catch(err => {
            statusSpan.textContent = 'Failed to load module';
            statusSpan.className = 'error';
            log("Fatal Error: " + err);
        });
    </script>
</body>
</html>